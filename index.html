<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>HTML Slide Editor - Modern UI</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

      * {
        box-sizing: border-box;
      }

      :root {
        --primary-color: #6366f1;
        --primary-hover: #5b5fd8;
        --primary-light: #e0e7ff;
        --secondary-color: #f1f5f9;
        --accent-color: #10b981;
        --accent-hover: #059669;
        --danger-color: #ef4444;
        --danger-hover: #dc2626;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --border-color: #e2e8f0;
        --border-hover: #cbd5e1;
        --background: #f8fafc;
        --surface: #ffffff;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1),
          0 4px 6px -4px rgb(0 0 0 / 0.1);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1),
          0 8px 10px -6px rgb(0 0 0 / 0.1);
        --radius-sm: 6px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --radius-xl: 16px;
      }

      body {
        margin: 0;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
        background: linear-gradient(135deg, var(--background) 0%, #f1f5f9 100%);
        color: var(--text-primary);
        line-height: 1.5;
      }

      .main-content-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 8px;
        overflow: hidden;
        gap: 8px;
      }

      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--surface);
        padding: 12px 20px;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.9);
        height: 60px;
        flex-shrink: 0;
      }

      .topbar h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .topbar h2::before {
        content: "🎨";
        font-size: 22px;
      }

      .topbar-buttons {
        display: flex;
        gap: 8px;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        font-family: inherit;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none;
        position: relative;
        overflow: hidden;
      }

      .btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--primary-hover)
        );
        color: white;
        box-shadow: var(--shadow-sm);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .btn-success {
        background: white;
      }

      .slide-list li {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100px;
        width: 80px;
        border: 2px dashed #ccc;
        border-radius: 8px;
        cursor: pointer;
        background-color: #f8f9fa;
        transition: background-color 0.2s;
      }

      .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .btn-secondary {
        background: var(--secondary-color);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
      }

      .btn-secondary:hover {
        background: var(--border-hover);
        transform: translateY(-1px);
      }

      .btn-danger {
        background: linear-gradient(
          135deg,
          var(--danger-color),
          var(--danger-hover)
        );
        color: white;
      }

      .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      #preview {
        flex: 1;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-xl);
        background: var(--surface);
        box-shadow: var(--shadow-md);
        overflow: hidden;
        padding: 20px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 0;
      }

      .slide-content {
        width: 100%;
        max-width: 890px;
        height: 530px;
        aspect-ratio: 16/9;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        background: white;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-lg);
        flex-shrink: 0;
      }

      .slide-content.has-content {
        border-color: var(--primary-color);
      }

      .slide-content-wrapper {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
      }

      .slide-content-inner {
        width: 100%;
        height: 100%;
        transform-origin: center center;
        transition: transform 0.3s ease;
        overflow: hidden;
        position: absolute;
        top: 0;
        left: 0;
      }

      .empty-state {
        text-align: center;
        color: var(--text-secondary);
        font-size: 16px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
      }

      .bottom-slide-navigator {
        height: 120px;
        background: var(--surface);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-xl);
        padding: 4px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: var(--shadow-md);
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.9);
        flex-shrink: 0;
      }

      .slide-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        gap: 12px;
        flex-grow: 1;
        height: 100%;
        overflow-x: auto;
        overflow-y: hidden;
        scroll-behavior: smooth;
      }

      .slide-list::-webkit-scrollbar {
        height: 4px;
      }

      .slide-list::-webkit-scrollbar-track {
        background: var(--secondary-color);
        border-radius: 2px;
      }

      .slide-list::-webkit-scrollbar-thumb {
        background: var(--border-hover);
        border-radius: 2px;
      }

      .slide-list::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
      }

      .slide-list li {
        position: relative;
        width: 128px;
        height: 96px;
        margin: 3px 0px 0px 3px;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-lg);
        background: var(--surface);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        overflow: hidden;
        flex-shrink: 0;
        box-shadow: var(--shadow-sm);
        cursor: move;
      }
      .thumbNailDrop.dragging {
        background: red;
      }
      .styleThumbNailLi :active {
        background: yellow;
      }

      .slide-list li.dragging {
        opacity: 0.5;
        box-shadow: 0 0 10px 3px #007bff;
      }

      .slide-list li:last-child {
        display: flex;
        font-size: larger;
        align-items: center;
        justify-content: center !important;
      }

      .slide-list li.active {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-light), var(--shadow-md);
        transform: scale(1.05);
      }

      .slide-list li:hover:not(.active) {
        border-color: var(--border-hover);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        display: flex;
      }

      .slide-list li:hover .buttonDel {
        display: flex;
        z-index: 100;
      }

      .slide-list li:last-child {
        display: flex;
        align-items: center;
        justify-content: baseline;
      }

      .thumbnail-container {
        width: 124px;
        height: 70px;
        margin-top: 4px;
        overflow: hidden;
        border-radius: var(--radius-sm);
        position: relative;
        background: var(--secondary-color);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .thumbnail-content {
        width: 960px;
        height: 540px;
        transform: scale(0.129);
        transform-origin: top left;
        position: absolute;
        top: 0;
        left: 0;
        background: white;
        border: 1px solid var(--border-color);
        overflow: hidden;
        pointer-events: none;
      }

      .thumbnail-placeholder {
        color: var(--text-secondary);
        font-size: 11px;
        text-align: center;
      }

      .slide-number {
        position: absolute;
        bottom: 4px;
        left: 6px;
        font-size: 10px;
        font-weight: 600;
        color: var(--surface);
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--primary-hover)
        );
        padding: 2px 6px;
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow-sm);
      }
      .buttonDel {
        position: absolute;
        border: none;
        font-size: 20px;
        cursor: pointer;
        top: 0px;
        right: 2px;
        font-size: 10px;
        display: none;
      }

      .popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(8px);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .popup.show {
        opacity: 1;
      }

      .popup-content {
        background: var(--surface);
        border-radius: var(--radius-xl);
        padding: 32px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        box-shadow: var(--shadow-xl);
        display: flex;
        flex-direction: column;
        gap: 20px;
        transform: scale(0.9);
        transition: transform 0.3s ease;
      }

      .popup.show .popup-content {
        transform: scale(1);
      }

      .popup h3 {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .popup h3::before {
        content: "✏️";
        font-size: 28px;
      }

      .popup textarea {
        width: 100%;
        height: 400px;
        font-family: "SF Mono", "Monaco", "Cascadia Code", "Roboto Mono",
          monospace;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 16px;
        resize: vertical;
        font-size: 14px;
        line-height: 1.6;
        background: var(--secondary-color);
        transition: border-color 0.2s ease;
      }

      .popup textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px var(--primary-light);
      }

      .popup-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }

      #presentation-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }

      #presentation-content {
        width: 100%;
        height: 100%;
        background: white;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .presentation-slide {
        width: 100%;
        height: auto;
        min-height: 600px;
        background: white;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .presentation-controls {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 16px;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        padding: 16px 24px;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
      }

      .presentation-controls .btn {
        background: rgba(255, 255, 255, 0.9);
        color: var(--text-primary);
        border: 1px solid rgba(255, 255, 255, 0.2);
        font-size: 16px;
        padding: 12px 24px;
      }

      .presentation-controls .btn:hover {
        background: rgba(255, 255, 255, 1);
        transform: translateY(-2px);
      }

      .presentation-controls .btn-danger {
        background: var(--danger-color);
        color: white;
      }

      /* Loading animation */
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .loading {
        animation: pulse 2s infinite;
      }

      /* Smooth scrolling */
      html {
        scroll-behavior: smooth;
      }

      /* Custom scrollbar for the main content */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: var(--secondary-color);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: var(--border-hover);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .main-content-area {
          padding: 8px;
          gap: 8px;
        }

        .topbar {
          padding: 10px;
          flex-direction: column;
          gap: 8px;
          height: auto;
        }

        .topbar-buttons {
          width: 100%;
          justify-content: center;
        }

        .popup-content {
          padding: 20px;
          margin: 20px;
        }

        .slide-list li {
          width: 100px;
          height: 75px;
        }

        .thumbnail-container {
          width: 96px;
          height: 54px;
        }

        .bottom-slide-navigator {
          height: 100px;
          padding: 8px;
        }
      }
      .thumbNailStyle {
        position: relative;
        background-color: red;
        color: red;
      }
    </style>
  </head>
  <body>
    <div class="main-content-area">
      <div class="topbar">
        <div style="display: flex; gap: 40px">
          <h2>Slide Editor</h2>
          <div style="display: flex">
            <p>Nhập tiêu đề:</p>
            <input
              style="height: 30px; margin-top: 10px; margin-right: 10px"
              type="text"
              id="titleInput"
              name="title"
              placeholder="Nhập tiêu đề..."
            />
            <input
              style="height: 30px; margin-top: 10px; margin-right: 10px"
              type="text"
              id="lectureId"
              name="title"
              placeholder="LectureId...."
            />
          </div>
        </div>

        <div class="topbar-buttons">
          <button
            id="htmlContent"
            class="btn btn-primary"
            onclick="Editor.showPopup()"
          >
            ✏️ Edit HTML
          </button>
          <button class="btn btn-success" onclick="Editor.togglePresentation()">
            🎥 Present
          </button>
          <button
            class="btn btn-primary"
            id="saveAllSlide"
            onclick="Editor.saveAllSlide()"
          >
            💾 Save
          </button>
        </div>
      </div>
      <div id="preview">
        <div class="slide-content" id="main-slide-content">
          <div class="slide-content-wrapper">
            <div class="slide-content-inner" id="main-slide-inner">
              <div class="empty-state">
                <p>🎨 Start creating your presentation!</p>
                <p>Click "Edit HTML" to add content to this slide.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="bottom-slide-navigator">
      <ul class="slide-list" id="slideList"></ul>
    </div>

    <div id="popup" class="popup">
      <div class="popup-content">
        <h3>Edit Slide HTML</h3>
        <textarea
          id="popupEditor"
          placeholder="Enter your HTML code here..."
        ></textarea>
        <div class="popup-buttons">
          <button class="btn btn-secondary" onclick="Editor.hidePopup()">
            ❌ Cancel
          </button>
          <button class="btn btn-primary" onclick="Editor.savePopup()">
            💾 Save & Preview
          </button>
        </div>
      </div>
    </div>

    <div id="presentation-container">
      <div id="presentation-content">
        <div class="presentation-slide" id="presentation-slide"></div>
      </div>
      <div class="presentation-controls">
        <button class="btn" onclick="Editor.prevSlide()">⬅️</button>
        <button class="btn" onclick="Editor.nextSlide()">➡️</button>
        <button class="btn btn-danger" onclick="Editor.exitPresentation()">
          Thoát
        </button>
      </div>
    </div>

    <script>
                  const Editor = (() => {
                    const slideListEl = document.getElementById("slideList");
                    const popupEditor = document.getElementById("popupEditor");
                    const mainSlideContent = document.getElementById("main-slide-content");
                    const mainSlideInner = document.getElementById("main-slide-inner");
                    const popup = document.getElementById("popup");
                    const presentationContainer = document.getElementById(
                      "presentation-container"
                    );
                    const presentationSlide = document.getElementById("presentation-slide");

                    let slides = [""];
                    let currentSlideIndex = 0;
                    let li = null;
                    function sanitizeHTML(html) {
                      // Basic HTML sanitization - remove script tags for security
                      return html.replace(
                        /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,
                        ""
                      );
                    }

                    function createThumbnail(htmlContent, index) {
                      const li = document.createElement("li");
                      li.draggable = "true";
                      li.classList.toggle("active", index === currentSlideIndex);
                      li.classList.add("thumbNailStyle");
                      const thumbContainer = document.createElement("div");
                      thumbContainer.className = "thumbnail-container";

                      if (htmlContent.trim()) {
                        const thumbnailContent = document.createElement("div");
                        thumbnailContent.className = "thumbnail-content";
                        thumbnailContent.innerHTML = sanitizeHTML(htmlContent);
                        thumbContainer.appendChild(thumbnailContent);
                      } else {
                        const placeholder = document.createElement("div");

                        placeholder.className = "thumbnail-placeholder";
                        placeholder.textContent = "Empty Slide";

                        thumbContainer.appendChild(placeholder);
                      }

                      li.appendChild(thumbContainer);
                      const buttonDel = document.createElement("button");
                      buttonDel.className = "buttonDel";
                      buttonDel.textContent = "❌";
                      thumbContainer.appendChild(buttonDel);
                      thumbContainer.onclick = function (e) {
                        const target = e.target;
                        const thumb = target.closest(".thumbnail");
                        const index = Number(currentSlideIndex);
                        if (target.classList.contains("buttonDel")) {
                          deleteSlide(index);
                        }
                      };

                      const slideNum = document.createElement("span");
                      slideNum.className = "slide-number";
                      slideNum.textContent = `${index + 1}`;
                      li.appendChild(slideNum);
                      li.onclick = () => {
                        currentSlideIndex = index;
                        updateMainPreview();
                        renderSlideList();
                      };
                      return li;
                    }

                    function renderSlideList() {
                      slideListEl.innerHTML = "";
                      const slidesData = [];
                      slides.forEach((htmlContent, index) => {
                        const li = createThumbnail(htmlContent, index);
                        slideListEl.appendChild(li);
                        // add data vào array
                        slidesData.push({
                          lecture_id: document.getElementById("lectureId").value,
                          title: document.getElementById("titleInput").value,
                          html_content:htmlContent,
                          slide_order: index+1,
                        });

                      });

                      const addSlideBtn = document.createElement("li");
                      addSlideBtn.className = "add-slide-item";
                      addSlideBtn.textContent = "+";
                      addSlideBtn.onclick = addSlide;

                      slideListEl.appendChild(addSlideBtn);
                      const activeLi = slideListEl.querySelector("li.active");
                      if (activeLi) {
                        activeLi.scrollIntoView({
                          behavior: "smooth",
                          block: "nearest",
                          inline: "center",
                        });
                      }
                      return slidesData;
                    }
                    function saveAllSlide() {
                      const slidesData = renderSlideList();
                      console.log(slidesData)
                      fetch("http://localhost:3000/api/createSlide", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ slides: slidesData }),
                    })
                      .then((res) => {
                        if (!res.ok) throw new Error("Lỗi lưu slides");
                        console.log(res)
                        return res.json();
                      })
                      .then((data) => {
                        console.log("✅ Lưu slides thành công:", data);
                        window.location.href = "/admin.html";
                      })
                      .catch((err) => {
                        console.error("❌ Lỗi lưu slides:", err);
                      });
                  }

                    

                    function updateMainPreview() {
                      const currentSlide = slides[currentSlideIndex];
                      if (currentSlide && currentSlide.trim()) {
                        mainSlideInner.innerHTML = sanitizeHTML(currentSlide);
                        mainSlideContent.classList.add("has-content");
                      } else {
                        mainSlideInner.innerHTML = `
                          <div class="empty-state">
                            <p>🎨 Start creating your presentation!</p>
                            <p>Click "Edit HTML" to add content to this slide.</p>
                          </div>
                        `;
                        mainSlideContent.classList.remove("has-content");
                      }
                    }

                    function updatePresentation() {
                      const currentSlide = slides[currentSlideIndex];
                      if (currentSlide && currentSlide.trim()) {
                        presentationSlide.innerHTML = sanitizeHTML(currentSlide);
                      } else {
                        presentationSlide.innerHTML = `
                          <div style="text-align: center; color: #64748b; font-size: 24px;">
                            <p>This slide is empty</p>
                            <p style="font-size: 16px;">Add some content to see it here!</p>
                          </div>
                        `;
                      }
                    }

                    function addSlide() {
                      const newSlideContent = ``;
                      slides.push(newSlideContent);
                      currentSlideIndex = slides.length - 1;
                      updateMainPreview();
                      renderSlideList();
                    }
                    function deleteSlide(index) {
                      if (confirm("Bạn muốn xóa slide này")) {
                        return slides.splice(index, 1);
                        if (slides.length === 0) {
                          currentSlideIndex == -1;
                        } else if (currentSlideIndex >= index) {
                          currentSlideIndex = Math.max(0, currentSlideIndex - 1);
                        }
                      }
                      updateMainPreview;
                      renderSlideList;
                    }

                    function showPopup() {
                      popupEditor.value = slides[currentSlideIndex] || "";
                      popup.style.display = "flex";
                      setTimeout(() => popup.classList.add("show"), 10);
                      popupEditor.focus();
                    }

                    function hidePopup() {
                      popup.classList.remove("show");
                      setTimeout(() => (popup.style.display = "none"), 300);
                    }

                    function savePopup() {
                      slides[currentSlideIndex] = popupEditor.value;
                      updateMainPreview();
                      renderSlideList();
                      hidePopup();
                    }

                    function togglePresentation() {
                      if (presentationContainer.style.display === "flex") {
                        exitPresentation();
                      } else {
                        updatePresentation();
                        presentationContainer.style.display = "flex";
                        // Try to go fullscreen if supported
                        if (presentationContainer.requestFullscreen) {
                          presentationContainer.requestFullscreen().catch(() => {
                            // Fullscreen failed, continue anyway
                          });
                        }
                      }
                    }

                    function exitPresentation() {
                      presentationContainer.style.display = "none";
                      if (document.exitFullscreen) {
                        document.exitFullscreen().catch(() => {
                          // Exit fullscreen failed, continue anyway
                        });
                      }
                    }

                    function prevSlide() {
                      if (currentSlideIndex > 0) {
                        currentSlideIndex--;
                        updatePresentation();
                      }
                    }

                    function nextSlide() {
                      if (currentSlideIndex < slides.length - 1) {
                        currentSlideIndex++;
                        updatePresentation();
                      }
                    }

                    // Handle keyboard shortcuts
                    document.addEventListener("keydown", (e) => {
                      if (presentationContainer.style.display === "flex") {
                        if (e.key === "ArrowLeft") {
                          e.preventDefault();
                          prevSlide();
                        } else if (e.key === "ArrowRight" || e.key === " ") {
                          e.preventDefault();
                          nextSlide();
                        } else if (e.key === "Escape") {
                          e.preventDefault();
                          exitPresentation();
                        }
                      } else if (popup.style.display === "flex") {
                        if (e.key === "Escape") {
                          e.preventDefault();
                          hidePopup();
                        } else if (e.ctrlKey && e.key === "Enter") {
                          e.preventDefault();
                          savePopup();
                        }
                      }
                    });

                    // Close popup when clicking outside
                    popup.addEventListener("click", (e) => {
                      if (e.target === popup) {
                        hidePopup();
                      }
                    });

                    function init() {
                      updateMainPreview();
                      renderSlideList();
                    }
                    function handleDrop(slides, onReorder) {
                      slideListEl.addEventListener("dragstart", (e) => {
                        const thumb = e.target.closest(".thumbNailDrop");
                        if (!thumb) return;
                        draggedIndex = Number(thumb.dataset.index); // create index thumbnail
                        e.dataTransfer.effectAllowed = "move"; // approve drop
                        e.dataTransfer.setData("text/plain", draggedIndex); // Dữ liệu truyền khi kéo
                        thumb.classList.add("dragging"); // add css
                      });
                      slideListEl.addEventListener("dragover", (e) => {
                        e.preventDefault(); // Bắt buộc để cho phép drop
                        const thumb = e.target.closest(".thumbNailDrop");
                        if (!thumb) return;

                        const hoverIndex = Number(thumb.dataset.index);
                        // Chèn vị trí đẩy thả (chèn trước hoặc sau tùy vị trí con trỏ)
                        const rect = thumb.getBoundingClientRect();
                        const offset = e.clientY - rect.top;

                        if (offset > rect.height / 2) {
                          thumbContainer.insertBefore(
                            document.querySelector(".dragging"),
                            thumb.nextSibling
                          );
                        } else {
                          thumbContainer.insertBefore(
                            document.querySelector(".dragging"),
                            thumb
                          );
                        }
                      });

                      slideListEl.addEventListener("drop", (e) => {
                        let draggedIndex = null;

                        e.preventDefault();
                        const draggedData = e.dataTransfer.getData("text/plain");
                        const droppedOnThumb = e.target.closest(".thumbNailDrop");
                        if (!droppedOnThumb) return;

                        const droppedIndex = Number(droppedOnThumb.dataset.index);

                        // Cập nhật lại mảng slides
                        const movedSlide = slides.splice(draggedIndex, 1)[0];
                        slides.splice(droppedIndex, 0, movedSlide);

                        // Cập nhật currentSlideIndex nếu cần (giống ví dụ trước)
                        if (currentSlideIndex === draggedIndex) {
                          currentSlideIndex = droppedIndex;
                        } else if (
                          currentSlideIndex > draggedIndex &&
                          currentSlideIndex <= droppedIndex
                        ) {
                          currentSlideIndex--;
                        } else if (
                          currentSlideIndex < draggedIndex &&
                          currentSlideIndex >= droppedIndex
                        ) {
                          currentSlideIndex++;
                        }
                        renderSlideList();
                        updateMainPreview();

                        document.querySelector(".dragging").classList.remove("dragging");
                        draggedIndex = null;
                      });

                      slideListEl.addEventListener("dragend", (e) => {
                        const dragging = document.querySelector(".dragging");
                        if (dragging) dragging.classList.remove("dragging");
                        draggedIndex = null;
                      });


                    }



                    return {
                      addSlide,
                      deleteSlide,
                      showPopup,
                      hidePopup,
                      savePopup,
                      init,
                      togglePresentation,
                      prevSlide,
                      nextSlide,
                      exitPresentation,
                      handleDrop,
                      saveAllSlide,
                    };
                  })();

                  Editor.init();
    </script>
  </body>
</html>
